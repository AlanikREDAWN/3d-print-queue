<!DOCTYPE html>
<html>
    <head>
        <title>3D Print Queue</title>
        <style>
            :root {
                --bg-color: #ffcdb2;
                --text-color: #6d6875;
                --nav-bg: #b5838d;
                --button-bg: #e5989b;
                --button-hover: #ffb4a2;
                --card-bg: white;
                --queue-border: #b5838d;
                --viewer-bg: #fcebe5;
            }

            .dark-mode {
                --bg-color: #2b2a30;
                --text-color: #f8f1f4;
                --nav-bg: #6d6875;
                --button-bg: #b5838d;
                --button-hover: #e5989b;
                --card-bg: #3d3b41;
                --queue-border: #e5989b;
                --viewer-bg: #4a4950;
            }

            body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                margin: 0;
                padding: 0;
                /* background-color: #f7f9fc; */
                /* background-color: #ffcdb2; */
                background-color: var(--bg-color);
                /* color: #333; */
                /* color: #6d6875; */
                color: var(--text-color);
                transition: background-color 0.3s, color 0.3s;
            }

            nav {
                /* background-color: #2d3748; */
                /* background-color: #b5838d; */
                background-color: var(--nav-bg);
                padding: 1rem;
                display: flex;
                gap: 1rem;
                justify-content: center;
            }

            nav button {
                /* background-color: #4a5568; */
                /* background-color: #e5989b; */
                background-color: var(--button-bg);
                color: white;
                border: none;
                padding: 0.6rem 1.2rem;
                border-radius: 5px;
                cursor: pointer;
                font-size: 1rem;
                transition: background-color 0.2s ease;
            }

            nav button:hover {
                /* background-color: #2b6cb0; */
                /* background-color: #ffb4a2; */
                background-color: var(--button-hover);
            }

            .section {
                display: none;
                padding: 2rem;
                max-width: 700px;
                margin: 0 auto;
                /* background: white; */
                background: var(--card-bg);
                margin-top: 2rem;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            }

            .visible {
                display: block;
            }

            form input,
            form textarea {
                width: 100%;
                padding: 0.6rem;
                margin-bottom: 1rem;
                /* border: 1px solid #ccc; */
                /* border: 1px solid #b5838d; */
                border: 1px solid var(--queue-border);
                border-radius: 5px;
                /* background-color: #fff; */
                background-color: var(--card-bg);
                /* color: #6d6875; */
                color: var(--text-color);
            }

            form button {
                /* background-color: #3182ce; */
                /* background-color: #e5989b; */
                background-color: var(--button-bg);
                color: white;
                border: none;
                padding: 0.8rem 1.5rem;
                border-radius: 5px;
                font-size: 1rem;
                cursor: pointer;
                transition: background-color 0.2s ease;
            }

            form button:hover {
                /* background-color: #2b6cb0; */
                /* background-color: #ffb4a2; */
                background-color: var(--button-hover);
            }

            #queue .job {
                /* background-color: #edf2f7; */
                /* background-color: #fff; */
                background-color: var(--card-bg);
                /* border-left: 6px solid #b5838d; */
                border-left: 6px solid var(--queue-border);
                padding: 1rem;
                border-radius: 8px;
                margin-bottom: 1rem;
                box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            }

            #queue .job button {
                margin: 0.3rem 0.2rem;
                padding: 0.3rem 0.8rem;
                font-size: 0.9rem;
                /* background-color: #e5989b; */
                background-color: var(--button-bg);
                color: white;
                border: none;
                border-radius: 4px;
                transition: background-color 0.2s ease;
            }

            #queue .job button:hover {
                /* background-color: #ffb4a2; */
                background-color: var(--button-hover);
            }

            #viewer {
                width: 100%;
                height: 500px;
                /* background-color: #e2e8f0; */
                /* background-color: #fcebe5; */
                background-color: var(--viewer-bg);
                border-radius: 10px;
                margin-top: 1rem;
            }

        </style>
        <script src="https://threejs.org/build/three.js"></script>
        <script type="module">
            import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.117.1/build/three.module.js';
        </script>
    </head>
    <body>
        <nav>
            <button onclick="showSection('upload')">Submit Job</button>
            <button onclick="showSection('admin')">Admin Login</button>
            <button onclick="showSection('dashboard')">Dashboard</button>
            <button onclick="logout()">Logout</button>
            <button id="themeToggle" onclick="toggleDarkMode()">üåô Dark Mode</button>
        </nav>

        

        <div id="upload" class="section visible">
            <h2>Submit a Print Job</h2>
            <form id="uploadForm" enctype="multipart/form-data">
                <input type="text" name="name" id="name" placeholder="Your Name" required /><br><br>
                <input type="file" name="file" id="file" accept=".stl,.gcode" required /><br><br>
                <input type="text" name="material" id="material" placeholder="Material" required />
                <input type="text" name="color" id="color" placeholder="Color" required />
                <!-- <input type="email" name="email" id="email" placeholder="Your Email" required /><br><br> -->
                <textarea name="notes" id="notes" placeholder="Notes (optional)"></textarea><br><br>
        
                <button type="submit">Submit Print Job</button><br><br>
            </form>
        </div>

        <div id="admin" class="section">
            <h2>Admin Login</h2>
            <form id="loginForm">
                <input type="text" name="username" placeholder="Username" />
                <input type="password" name="password" placeholder="Password" />
                <button type="submit">Login</button>
            </form>
        </div>

        <div id="dashboard" class="section">
            <h2>Print Queue</h2>
            <div id="queue">Loading...</div>
        </div>

        <!-- <script type="module">
            import * as THREE from 'three';
            import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
           
        </script> -->

        <!-- <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
        <script src="https://unpkg.com/three@0.160.0/examples/js/loaders/STLLoader.js"></script>
        <script src="https://unpkg.com/three@0.160.0/examples/js/controls/OrbitControls.js"></script> -->
        

        <script type="importmap">
            {
                "imports": {
                    "three": "https://cdn.jsdelivr.net/npm/three@0.179.1/build/three.module.js",
                    "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.179.1/examples/jsm/"
                }
            }
        </script>


        
        <script>
            
            // import * as THREE from './node_modules/three';
            // import { OrbitControls } from './node_modules/three/addons/controls/OrbitControls.js';
            
            const token = localStorage.getItem('adminToken');

            function showSection(id) {
                document.querySelectorAll('.section').forEach(sec => sec.classList.remove('visible'));
                document.getElementById(id).classList.add('visible');

                if (id === 'dashboard') fetchQueue();
            }

            function logout() {
                localStorage.removeItem('adminToken');
                alert('Logged out');
                showSection('upload');
            }

            document.getElementById('uploadForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);

                const res = await fetch('/upload', {
                    method: 'POST',
                    body: formData,
                });

                const data = await res.json();
                alert(data.message);
                e.target.reset();
            });

            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const formData = new FormData(e.target);
                const body = {
                    username: formData.get('username'),
                    password: formData.get('password')
                };

                const res = await fetch('auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await res.json();
                if (data.token) {
                    localStorage.setItem('adminToken', data.token);
                    alert('Logged in!');

                    showSection('dashboard')
                } else {
                    alert('Login failed');
                }
            });

            async function fetchQueue() {
                const token = localStorage.getItem('adminToken');
                if (!token) {
                    alert('Not logged in');
                    showSection('admin');
                    return
                }

                const res = await fetch('/queue', {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const jobs = await res.json();

                const container = document.getElementById('queue');
                container.innerHTML = '';

                jobs.forEach(job => {
                    const el = document.createElement('div');
                    el.className = 'job';
                    el.innerHTML = `
                        <strong>${job.name || 'Unknown'}</strong><br> submitted <br><code>${job.fileName}</code><br>
                        <p>${job.material}</p>
                        <p>${job.color}</p>
                        <p>${job.notes || 'No notes'}</p>
                        <button onclick="downloadFile('${job.storedFileName}')">‚¨á Download STL</button><br>
                        <button onclick="openPreview('${job.storedFileName}')">üëÅÔ∏è Preview</button><br>
                        <small>Status: <b>${job.status}</b></small><br>
                        <button onclick="updateStatus('${job._id}', 'done')">‚úî Done</button>
                        <button onclick="updateStatus('${job._id}', 'failed')">‚úñ Failed</button>
                        <button onclick="deleteJob('${job._id}')">üóë Delete</button>

                        
                    `;
                    container.appendChild(el);
                });
            }

            async function downloadFile(fileName) {
                const token = localStorage.getItem('adminToken');

                fetch(`/download/${fileName}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                })
                .then(res => {
                    if (!res.ok) throw new Error('Download failed');
                    return res.blob()
                })
                .then(blob => {
                    const url = URL.createObjectURL(blob);
                    const a  = document.createElement('a');
                    a.href = url;
                    a.download = fileName;
                    document.body.appendChild(a);
                    a.click()
                    a.remove()
                    URL.revokeObjectURL(url);
                })
                .catch(err => console.error(err));
            }

            async function updateStatus(id, status) {
                const token = localStorage.getItem('adminToken');
                await fetch(`/job/${id}/status`, {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                        Authorization: `Bearer ${token}`,
                    },
                    body: JSON.stringify({ status })
                });
                fetchQueue();
            }

            async function deleteJob(id) {
                const token = localStorage.getItem('adminToken');
                await fetch(`/job/${id}`, {
                    method: 'DELETE',
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                });
                fetchQueue();
            }

            let renderer, scene, camera, controls;

            function openPreview(fileName) {
                const model = document.getElementById('previewModel');
                model.style.display = 'block';

                const token = localStorage.getItem('adminToken');
                const url = `/download/${fileName}`;

                fetch(url, {
                    headers: {
                        Authorization: `Bearer ${token}`
                    }
                })
                .then(res => res.blob())
                .then(blob => {
                    const objectURL = URL.createObjectURL(blob);
                    renderSTL(objectURL);
                });
            }

            function closePreview() {
                const model = document.getElementById('previewModel');
                model.style.display = 'none';

                if (renderer) {
                    renderer.dispose();
                    document.getElementById('viewer').innerHTML = '';
                }
            }

            function renderSTL(stlUrl) {
                const container = document.getElementById('viewer');

                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf0f0f0);

                camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
                camera.position.set(0, 0, 100);

                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(container.clientWidth, container.clientHeight);
                container.innerHTML = '';
                container.appendChild(renderer.domElement);

                controls = new OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;

                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(0, 0, 100).normalize();
                scene.add(light);
                scene.add(new THREE.AmbientLight(0x404040));

                const loader = new THREE.STLLoader();
                loader.load(stlUrl, function (geometry) {
                    console.log("STL loaded:", geometry);
                    const material = new THREE.MeshStandardMaterial({ color: 0x606060 });
                    const mesh = new THREE.Mesh(geometry, material);
                    geometry.center();
                    scene.add(mesh);
                });

                function animate() {
                    requestAnimationFrame(animate);
                    controls.update();
                    renderer.render(scene, camera);
                }
                animate();
            }

            
        </script>
        <script type="module">
            // import * as THREE from 'three';
            // import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.117.1/build/three.module.js';

            // let renderer, scene, camera, controls;

            // function openPreview(fileName) {
            //     const model = document.getElementById('previewModel');
            //     model.style.display = 'block';

            //     const token = localStorage.getItem('adminToken');
            //     const url = `/download/${fileName}`;

            //     fetch(url, {
            //         headers: {
            //             Authorization: `Bearer ${token}`
            //         }
            //     })
            //     .then(res => res.blob())
            //     .then(blob => {
            //         const objectURL = URL.createObjectURL(blob);
            //         renderSTL(objectURL);
            //     });
            // }

            // function closePreview() {
            //     const model = document.getElementById('previewModel');
            //     model.style.display = 'none';

            //     if (renderer) {
            //         renderer.dispose();
            //         document.getElementById('viewer').innerHTML = '';
            //     }
            // }

            // function renderSTL(stlUrl) {
            //     const container = document.getElementById('viewer');

            //     scene = new THREE.Scene();
            //     scene.background = new THREE.Color(0xf0f0f0);

            //     camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
            //     camera.position.set(0, 0, 100);

            //     renderer = new THREE.WebGLRenderer({ antialias: true });
            //     renderer.setSize(container.clientWidth, container.clientHeight);
            //     container.innerHTML = '';
            //     container.appendChild(renderer.domElement);

            //     controls = new OrbitControls(camera, renderer.domElement);
            //     controls.enableDamping = true;

            //     const light = new THREE.DirectionalLight(0xffffff, 1);
            //     light.position.set(0, 0, 100).normalize();
            //     scene.add(light);
            //     scene.add(new THREE.AmbientLight(0x404040));

            //     const loader = new THREE.STLLoader();
            //     loader.load(stlUrl, function (geometry) {
            //         console.log("STL loaded:", geometry);
            //         const material = new THREE.MeshStandardMaterial({ color: 0x606060 });
            //         const mesh = new THREE.Mesh(geometry, material);
            //         geometry.center();
            //         scene.add(mesh);
            //     });

            //     function animate() {
            //         requestAnimationFrame(animate);
            //         controls.update();
            //         renderer.render(scene, camera);
            //     }
            //     animate();
            // }
        </script>
        <script>
            function toggleDarkMode() {
                const isDark = document.body.classList.toggle('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                document.getElementById('themeToggle').textContent = isDark ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
            }

            if (localStorage.getItem('theme') === 'dark') {
                document.body.classList.add('dark-mode');
            }
            document.getElementById('themeToggle').textContent =
                document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è Light Mode' : 'üåô Dark Mode';
        </script>
        <!-- <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/controls/OrbitControls.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/examples/js/loaders/STLLoader.js"></script> -->
        
    </body>
</html>